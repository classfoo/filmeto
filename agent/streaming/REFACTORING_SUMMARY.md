# æµå¼æ¶ˆæ¯é‡æ„æ€»ç»“

## é‡æ„ç›®æ ‡

åŒºåˆ†ä¸»agentï¼ˆMain Agentï¼‰çš„roleå’Œå­agentï¼ˆSub-Agentï¼‰çš„æ¶ˆæ¯ï¼Œå®ç°æ¸…æ™°çš„æ¶ˆæ¯èšåˆç­–ç•¥ã€‚

## å®ç°çš„åŠŸèƒ½

### 1. è§’è‰²åˆ†ç±»ä½“ç³»

#### ä¸»Agentè§’è‰²ï¼ˆMain Agent Rolesï¼‰
è´Ÿè´£ä»»åŠ¡åè°ƒã€è®¡åˆ’å’Œæµç¨‹æ§åˆ¶ï¼Œæ¶ˆæ¯èšåˆåˆ°ç»Ÿä¸€çš„"MainAgent"ï¼š

- `COORDINATOR` - åè°ƒè€…
- `PLANNER` - è®¡åˆ’è€…
- `QUESTION_UNDERSTANDING` - é—®é¢˜ç†è§£
- `EXECUTOR` - æ‰§è¡Œè€…ï¼ˆå·¥å…·è°ƒç”¨ï¼‰
- `PLAN_REFINEMENT` - è®¡åˆ’ä¼˜åŒ–
- `RESPONSE` - å“åº”ç”Ÿæˆ
- `REVIEWER` - ç»“æœè¯„å®¡
- `SYNTHESIZER` - ç»“æœç»¼åˆ

#### å­Agentè§’è‰²ï¼ˆSub-Agent Rolesï¼‰
å½±è§†åˆ¶ä½œä¸“ä¸šå›¢é˜Ÿï¼Œå„è‡ªç»´æŠ¤ç‹¬ç«‹æ¶ˆæ¯æµï¼š

- `PRODUCTION` - åˆ¶ç‰‡äºº
- `DIRECTOR` - å¯¼æ¼”
- `SCREENWRITER` - ç¼–å‰§
- `ACTOR` - æ¼”å‘˜
- `MAKEUP_ARTIST` - åŒ–å¦†å¸ˆ
- `SUPERVISOR` - åœºè®°
- `SOUND_MIXER` - éŸ³å“å¸ˆ
- `EDITOR` - å‰ªè¾‘å¸ˆ

### 2. æ ¸å¿ƒä»£ç å˜æ›´

#### agent/streaming/protocol.py

1. **æ–°å¢è§’è‰²æšä¸¾å€¼**ï¼š
   ```python
   MAIN_AGENT = "main_agent"
   QUESTION_UNDERSTANDING = "question_understanding"
   EXECUTOR = "executor"
   PLAN_REFINEMENT = "plan_refinement"
   RESPONSE = "response"
   REVIEWER = "reviewer"
   SYNTHESIZER = "synthesizer"
   ```

2. **æ–°å¢è§’è‰²åˆ†ç±»æ–¹æ³•**ï¼š
   ```python
   @classmethod
   def is_main_agent_role(cls, role: 'AgentRole') -> bool
   
   @classmethod
   def is_sub_agent_role(cls, role: 'AgentRole') -> bool
   ```

3. **StreamEventEmitterå¢å¼º**ï¼š
   ```python
   # æ–°å¢ä¸»agentèšåˆmessage_id
   self._main_agent_message_id: Optional[str] = None
   
   def _get_main_agent_message_id(self) -> str
   def _reset_main_agent_message_id(self)
   ```

4. **æ‰€æœ‰emitæ–¹æ³•æ›´æ–°**ï¼š
   - è‡ªåŠ¨æ£€æµ‹è§’è‰²ç±»å‹
   - ä¸»agentè§’è‰²ä½¿ç”¨èšåˆmessage_id
   - å­agentä½¿ç”¨ç‹¬ç«‹message_id
   - ä¿å­˜åŸå§‹è§’è‰²ä¿¡æ¯åˆ°metadata

#### agent/filmeto_agent.py

1. **æ›´æ–°èŠ‚ç‚¹åˆ°è§’è‰²çš„æ˜ å°„**ï¼š
   ```python
   node_to_agent = {
       "question_understanding": "QuestionUnderstanding",
       "coordinator": "Coordinator",
       "planner": "Planner",
       "use_tools": "Executor",
       "respond": "Response",
       "review_plan": "Reviewer",
       "refine_plan": "PlanRefinement",
       "synthesize_results": "Synthesizer",
   }
   ```

2. **ä¿®æ­£äº‹ä»¶å‘é€**ï¼š
   ```python
   emitter.emit_agent_start("QuestionUnderstanding", AgentRole.QUESTION_UNDERSTANDING)
   ```

#### agent/nodes/sub_agent_executor.py

1. **ä¿®æ­£Reviewerå’ŒSynthesizerçš„è§’è‰²**ï¼š
   ```python
   emitter.emit_agent_start("Reviewer", AgentRole.REVIEWER)
   emitter.emit_agent_start("Synthesizer", AgentRole.SYNTHESIZER)
   ```

## æ¶ˆæ¯æµç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·è¯·æ±‚åˆ›å»ºçŸ­ç‰‡

```
ç”¨æˆ·è¯·æ±‚: "åˆ›å»ºä¸€ä¸ªå…³äºå¤ªç©ºæ¢é™©çš„çŸ­ç‰‡"

1. MainAgent (é—®é¢˜ç†è§£) â†’ message_id: "msg-A"
   - åˆ†æä»»åŠ¡ç±»å‹
   - åˆ¤æ–­éœ€è¦å¤šagentåä½œ

2. MainAgent (è®¡åˆ’åˆ¶å®š) â†’ message_id: "msg-A" (ç›¸åŒ)
   - åˆ›å»ºæ‰§è¡Œè®¡åˆ’
   - åˆ†é…ä»»åŠ¡ç»™å­agents

3. Screenwriter â†’ message_id: "msg-B" (ç‹¬ç«‹)
   - æ‰§è¡Œ: å‰§æœ¬å¤§çº²åˆ›ä½œ
   - ç»“æœ: å®Œæˆå‰§æœ¬

4. Director â†’ message_id: "msg-C" (ç‹¬ç«‹)
   - æ‰§è¡Œ: åˆ†é•œè®¾è®¡
   - ç»“æœ: å®Œæˆåˆ†é•œ

5. MainAgent (ç»“æœè¯„å®¡) â†’ message_id: "msg-A" (ç›¸åŒ)
   - è¯„å®¡æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œæƒ…å†µ
   - æ£€æŸ¥è´¨é‡

6. MainAgent (ç»“æœç»¼åˆ) â†’ message_id: "msg-A" (ç›¸åŒ)
   - ç»¼åˆå„å­agentçš„å·¥ä½œæˆæœ
   - ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
```

## UIæ˜¾ç¤ºæ•ˆæœ

```
â”Œâ”€ User â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»ºä¸€ä¸ªå…³äºå¤ªç©ºæ¢é™©çš„çŸ­ç‰‡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ğŸ¤– MainAgent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ é—®é¢˜ç†è§£: ä»»åŠ¡ç±»å‹ full_production    â”‚
â”‚ â€¢ è®¡åˆ’åˆ¶å®š: åˆ›å»º4ä¸ªä»»åŠ¡...              â”‚
â”‚ â€¢ ä»»åŠ¡åˆ†é…: Screenwriter, Director...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ âœï¸ Screenwriter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… å‰§æœ¬å¤§çº²åˆ›ä½œå®Œæˆ                      â”‚
â”‚ è´¨é‡è¯„åˆ†: 0.85                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ğŸ¥ Director â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… åˆ†é•œè®¾è®¡å®Œæˆ                          â”‚
â”‚ è´¨é‡è¯„åˆ†: 0.90                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ğŸ¤– MainAgent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ç»“æœè¯„å®¡: æ‰€æœ‰ä»»åŠ¡æˆåŠŸ                 â”‚
â”‚ â€¢ ç»“æœç»¼åˆ: çŸ­ç‰‡åˆ¶ä½œç´ æå°±ç»ª             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¼˜åŠ¿

### 1. æ¸…æ™°çš„èŒè´£åˆ†ç¦»
- ä¸»agent = åè°ƒå’Œç®¡ç†
- å­agent = ä¸“ä¸šæ‰§è¡Œ
- UIä¸€ç›®äº†ç„¶

### 2. å‡å°‘ä¿¡æ¯å™ªéŸ³
- ä¸»agentå†…éƒ¨åè°ƒè¿‡ç¨‹èšåˆæ˜¾ç¤º
- é¿å…è¿‡å¤šæ¶ˆæ¯æ°”æ³¡
- ç”¨æˆ·å…³æ³¨é‡ç‚¹å†…å®¹

### 3. ä¿ç•™å®Œæ•´ä¿¡æ¯
- metadataä¿å­˜åŸå§‹è§’è‰²
- ä¾¿äºè°ƒè¯•å’Œåˆ†æ
- ä¸ä¸¢å¤±ä»»ä½•ç»†èŠ‚

### 4. æ›´å¥½çš„å¯æ‰©å±•æ€§
- æ–°å¢ä¸»agentè§’è‰²ï¼šæ·»åŠ åˆ°åˆ†ç±»å³å¯
- æ–°å¢å­agentï¼šè‡ªåŠ¨è·å¾—ç‹¬ç«‹æ¶ˆæ¯æµ
- çµæ´»çš„å±•ç¤ºç­–ç•¥

## æµ‹è¯•è¦†ç›–

è¿è¡Œæµ‹è¯•ï¼š
```bash
python tests/test_agent_role_aggregation.py
```

æµ‹è¯•å†…å®¹ï¼š
- âœ… ä¸»agentè§’è‰²åˆ†ç±»æ­£ç¡®æ€§
- âœ… å­agentè§’è‰²åˆ†ç±»æ­£ç¡®æ€§
- âœ… ä¸»agentæ¶ˆæ¯å…±äº«message_id
- âœ… å­agentæ¶ˆæ¯ç‹¬ç«‹message_id
- âœ… æ··åˆåœºæ™¯ä¸‹çš„æ¶ˆæ¯éš”ç¦»
- âœ… è§’è‰²åç§°åˆ°æšä¸¾çš„æ˜ å°„

## ä½¿ç”¨ç¤ºä¾‹

è¿è¡Œæ¼”ç¤ºï¼š
```bash
python examples/example_agent_role_aggregation.py
```

## APIå…¼å®¹æ€§

### å®Œå…¨å…¼å®¹
- æ‰€æœ‰ç°æœ‰çš„emitæ–¹æ³•è°ƒç”¨éƒ½ä¿æŒå…¼å®¹
- è‡ªåŠ¨å¤„ç†è§’è‰²èšåˆï¼Œæ— éœ€ä¿®æ”¹è°ƒç”¨ä»£ç 
- metadataå­—æ®µæä¾›åŸå§‹è§’è‰²ä¿¡æ¯è®¿é—®

### æ–°å¢åŠŸèƒ½
```python
# æ£€æŸ¥è§’è‰²ç±»å‹
if AgentRole.is_main_agent_role(role):
    # å¤„ç†ä¸»agentæ¶ˆæ¯
    pass

if AgentRole.is_sub_agent_role(role):
    # å¤„ç†å­agentæ¶ˆæ¯
    pass

# è®¿é—®åŸå§‹è§’è‰²ä¿¡æ¯
original_role = event.metadata.get("original_role")
original_name = event.metadata.get("original_name")
```

## æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶
1. `/agent/streaming/protocol.py` - æ ¸å¿ƒåè®®å¢å¼º
2. `/agent/filmeto_agent.py` - ä¸»agenté€»è¾‘æ›´æ–°
3. `/agent/nodes/sub_agent_executor.py` - å­agentæ‰§è¡Œå™¨æ›´æ–°

### æ–°å¢çš„æ–‡ä»¶
1. `/agent/streaming/AGENT_ROLE_AGGREGATION.md` - è¯¦ç»†è®¾è®¡æ–‡æ¡£
2. `/agent/streaming/REFACTORING_SUMMARY.md` - æœ¬æ–‡æ¡£
3. `/tests/test_agent_role_aggregation.py` - å•å…ƒæµ‹è¯•
4. `/examples/example_agent_role_aggregation.py` - ä½¿ç”¨ç¤ºä¾‹

## åç»­å»ºè®®

### UIå±‚ä¼˜åŒ–
1. æ·»åŠ "å±•å¼€MainAgentè¯¦æƒ…"åŠŸèƒ½ï¼Œæ˜¾ç¤ºå†…éƒ¨å„è§’è‰²å…·ä½“å·¥ä½œ
2. ä¸ºMainAgentæ¶ˆæ¯æ·»åŠ è¿›åº¦æŒ‡ç¤ºå™¨
3. æ·»åŠ æ¶ˆæ¯è¿‡æ»¤ï¼šåªçœ‹ä¸»agent / åªçœ‹å­agent
4. æ¶ˆæ¯æŠ˜å åŠŸèƒ½ï¼šå‹ç¼©è¿‡é•¿çš„å†…éƒ¨æ—¥å¿—

### åŠŸèƒ½å¢å¼º
1. æ”¯æŒè‡ªå®šä¹‰æ¶ˆæ¯èšåˆç­–ç•¥
2. æ·»åŠ æ¶ˆæ¯åˆ†ç»„API
3. æ”¯æŒæ¶ˆæ¯æœç´¢å’Œè¿‡æ»¤
4. æ·»åŠ æ¶ˆæ¯å¯¼å‡ºåŠŸèƒ½

### æ€§èƒ½ä¼˜åŒ–
1. æ¶ˆæ¯æ‰¹é‡å¤„ç†
2. å¤§é‡æ¶ˆæ¯æ—¶çš„è™šæ‹Ÿæ»šåŠ¨
3. æ¶ˆæ¯ç¼“å­˜ç­–ç•¥
4. å¼‚æ­¥æ¶ˆæ¯å¤„ç†

## ç»“è®º

æœ¬æ¬¡é‡æ„æˆåŠŸå®ç°äº†ä¸»agentå’Œå­agentçš„æ¶ˆæ¯åˆ†ç¦»å’Œèšåˆï¼Œæä¾›äº†æ›´æ¸…æ™°çš„ç”¨æˆ·ä½“éªŒå’Œæ›´å¥½çš„å¼€å‘ä½“éªŒã€‚æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œä»£ç å®Œå…¨å‘åå…¼å®¹ï¼Œå¯ä»¥å®‰å…¨éƒ¨ç½²ã€‚
